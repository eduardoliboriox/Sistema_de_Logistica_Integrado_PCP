{% extends "base.html" %}
{% block title %}Dashboard - Log√≠stica Venttos{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">üì¶ Painel de Produ√ß√£o - {{ selected_date }}</h2>

  <!-- Filtro de data -->
  <form method="get" action="/">
    <div class="row mb-3">
      <div class="col-auto">
        <label for="data" class="form-label">Selecionar Data:</label>
        <input type="date" id="data" name="data" class="form-control" value="{{ selected_date }}">
      </div>
      <div class="col-auto align-self-end">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
      <div class="col-auto align-self-end">
        <button type="button" id="import-now" class="btn btn-success">Importar Planilha Agora</button>
      </div>
    </div>
  </form>

  <hr>

  {% if grouped %}
    {% for cliente, itens in grouped.items() %}
    <div class="card my-4 shadow-sm">
      <div class="card-header bg-light fw-bold">
        {{ cliente }}
      </div>
      <div class="card-body p-0">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th>Modelo</th>
              <th>Quantidade</th>
              <th>Status</th>
              <th>√öltima Atualiza√ß√£o</th>
            </tr>
          </thead>
          <tbody>
            {% for item in itens %}
            <tr>
              <td>{{ item.modelo }}</td>
              <td>{{ item.quantidade }}</td>
              <td>
                <select class="form-select status-select" data-modelo="{{ item.modelo }}">
                  <option {% if item.status == 'Apontamento PCP' %}selected{% endif %}>Apontamento PCP</option>
                  <option {% if item.status == 'Recebido' %}selected{% endif %}>Recebido</option>
                  <option {% if item.status == 'Pronto' %}selected{% endif %}>Pronto</option>
                  <option {% if item.status == 'Notas sendo faturadas' %}selected{% endif %}>Notas sendo faturadas</option>
                  <option {% if item.status == 'Faturamento confirmado' %}selected{% endif %}>Faturamento confirmado</option>
                  <option {% if item.status == 'Entrega em andamento' %}selected{% endif %}>Entrega em andamento</option>
                  <option {% if item.status == 'Entrega conclu√≠da' %}selected{% endif %}>Entrega conclu√≠da</option>
                </select>
              </td>
              <td id="update-{{ item.modelo }}">{{ item.hora }} - {{ item.usuario }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <p>Nenhum dado encontrado para a data selecionada.</p>
  {% endif %}
</div>

<!-- Modal de senha -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirma√ß√£o de Altera√ß√£o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <p>Digite sua senha para confirmar a altera√ß√£o de status.</p>
        <input type="password" id="confirmPassword" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="confirmChange" class="btn btn-primary">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    let modeloSelecionado = null;
    let novoStatus = null;

    // Listener para abrir modal quando o status muda
    document.querySelectorAll('.status-select').forEach(sel => {
        sel.addEventListener('change', (e) => {
            modeloSelecionado = e.target.dataset.modelo;
            novoStatus = e.target.value;
            const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
            modal.show();
        });
    });

    // Confirmar altera√ß√£o
    document.getElementById('confirmChange').addEventListener('click', () => {
        const senha = document.getElementById('confirmPassword').value;

        fetch('/update_status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({modelo: modeloSelecionado, status: novoStatus, senha: senha})
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('update-' + modeloSelecionado).textContent = `${data.hora} - ${data.usuario}`;
                alert('Status atualizado com sucesso!');
            } else {
                alert(data.msg || 'Erro ao atualizar status!');
            }
            document.getElementById('confirmPassword').value = '';
            bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
        });
    });

    // Importar planilha agora
    document.getElementById('import-now').addEventListener('click', () => {
        fetch('/pcp/import_now', {method: 'POST'})
        .then(res => res.json())
        .then(data => {
            if (data.ok) {
                alert(`Importa√ß√£o conclu√≠da!\nCriados: ${data.resumo.created}, Atualizados: ${data.resumo.updated}`);
                location.reload(); // recarrega dashboard
            } else {
                alert('Erro na importa√ß√£o!');
            }
        });
    });

    // Auto refresh a cada 60 segundos
    setInterval(() => location.reload(), 60000);
});
</script>
{% endblock %}
